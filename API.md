# Point-E API Documentation

Complete API reference for both local and production Point-E servers.

## Base URLs

- **Local Server**: `http://localhost:8000`
- **Production (GCP)**: `https://your-domain.com` (or use your load balancer IP)

## Authentication

The API uses shared secret authentication when `POINT_E_SECRET_KEY` is configured:

- **Header**: `Authorization: Bearer YOUR_SECRET_KEY`
- **Required for**: All generation endpoints when secret is configured
- **Rate Limiting**: 5 requests per forwarded IP per day (configurable)

## Content Types

- **Request**: `application/json` (for JSON payloads)
- **Response**: `application/json`
- **File Upload**: `multipart/form-data` (for image uploads)

## Endpoints

### 1. Server Information

Get information about the server and its capabilities.

#### Request
```http
GET /
```

#### Response (Local Server)
```json
{
  "status": "Point-E Local Server",
  "version": "1.0.0",
  "device": "CUDA GPU (NVIDIA L4)",
  "models_ready": true,
  "output_directory": "/path/to/generated_models",
  "features": ["text-to-3d", "image-to-3d"]
}
```

#### Response (Production Server)
```json
{
  "status": "Point-E Production Server",
  "version": "3.0.0",
  "gpu_available": true,
  "models_ready": true,
  "storage": "Google Cloud Storage",
  "features": ["text-to-3d", "image-to-3d", "user-storage"]
}
```

### 2. Health Check

Check if the server is healthy and models are loaded.

#### Request
```http
GET /health
```

#### Response
```json
{
  "status": "healthy",
  "models_ready": true,
  "device": "CUDA GPU (NVIDIA L4)"  // Local server only
}
```

### 3. Generate 3D Model from Text

Generate a 3D mesh from a text description.

#### Request
```http
POST /generate/text
Content-Type: application/json
```

#### Request Body
```json
{
  "prompt": "a red sports car",
  "user_id": "user123",          // Optional, defaults to "local"
  "format": "mesh",              // Optional, currently only "mesh" supported
  "grid_size": 32,               // Optional, mesh resolution (16-64)
  "num_samples": 1               // Optional, always 1 currently
}
```

#### Parameters
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| prompt | string | required | Text description of the 3D object |
| user_id | string | "local" | User identifier for organizing files |
| format | string | "mesh" | Output format (only "mesh" supported) |
| grid_size | integer | 32 | Mesh resolution. Higher = more detailed but slower |
| num_samples | integer | 1 | Number of samples (currently only 1) |

#### Response (Local Server)
```json
{
  "success": true,
  "message": "Generated mesh: a red sports car",
  "file_url": "/download/user123/mesh_a_red_sports_car_20250830_120000.ply",
  "file_path": "/home/user/generated_models/user123/mesh_a_red_sports_car_20250830_120000.ply",
  "user_id": "user123",
  "vertices": 1024,
  "faces": 2048,
  "device_used": "CUDA GPU (NVIDIA L4)",
  "generation_time": 28.5
}
```

#### Response (Production Server)
```json
{
  "success": true,
  "message": "Generated mesh: a red sports car",
  "file_url": "/download/mesh_a_red_sports_car_20250830_120000.ply",
  "download_url": "https://storage.googleapis.com/...",  // GCS signed URL
  "user_id": "user123",
  "vertices": 1024,
  "faces": 2048,
  "expires_at": "2025-09-29T12:00:00"
}
```

#### Example
```bash
curl -X POST http://localhost:8000/generate/text \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "a medieval castle",
    "user_id": "john-doe",
    "grid_size": 32
  }'
```

### 4. Generate 3D Model from Image

Generate a 3D mesh from an uploaded image.

#### Request
```http
POST /generate/image
Content-Type: multipart/form-data
```

#### Form Data
| Field | Type | Default | Description |
|-------|------|---------|-------------|
| file | file | required | Image file (JPG, PNG) |
| user_id | string | "local" | User identifier |
| grid_size | integer | 32 | Mesh resolution |

#### Response
Similar to text generation endpoint.

#### Example
```bash
curl -X POST http://localhost:8000/generate/image \
  -F "file=@castle.jpg" \
  -F "user_id=john-doe" \
  -F "grid_size=32"
```

### 5. Download Generated Model

Download a generated PLY file.

#### Request (Local Server)
```http
GET /download/{user_id}/{filename}
```

#### Request (Production Server)
```http
GET /download/{filename}
```

#### Response
Binary PLY file with appropriate headers.

#### Example
```bash
# Local server
curl -O http://localhost:8000/download/john-doe/mesh_castle_20250830_120000.ply

# Production server (or use the GCS signed URL)
curl -O https://your-domain.com/download/mesh_castle_20250830_120000.ply
```

### 6. List User's Models (Production Only)

Get all models generated by a specific user.

#### Request
```http
GET /user/{user_id}/models
```

#### Response
```json
{
  "user_id": "john-doe",
  "models": [
    {
      "filename": "mesh_castle_20250830_120000.ply",
      "path": "users/john-doe/2025/08/30/mesh_castle_20250830_120000.ply",
      "download_url": "https://storage.googleapis.com/...",
      "created": "2025-08-30T12:00:00Z",
      "size": 245632,
      "type": "mesh"
    }
  ],
  "total_count": 1
}
```

### 7. Browse Models (Local Server Only)

Browse all generated models in the web interface.

#### Request
```http
GET /browse
```

Opens a file browser showing the `generated_models/` directory.

### 8. Check IP Usage (Authenticated)

Check rate limit usage for a specific IP address.

#### Request
```http
GET /usage/{ip}
Authorization: Bearer YOUR_SECRET_KEY
```

#### Response
```json
{
  "ip": "123.45.67.89",
  "used": 3,
  "limit": 5,
  "remaining": 2,
  "window_seconds": 86400,
  "reset_time": 1693526400
}
```

#### Example
```bash
curl -X GET http://your-server/usage/123.45.67.89 \
  -H "Authorization: Bearer YOUR_SECRET_KEY"
```

### 9. API Documentation (Interactive)

Access interactive Swagger/OpenAPI documentation.

#### Request
```http
GET /docs
```

## Response Codes

| Code | Description |
|------|-------------|
| 200 | Success |
| 400 | Bad Request (invalid parameters) |
| 401 | Unauthorized (invalid or missing secret key) |
| 404 | Not Found (file not found) |
| 422 | Validation Error (missing required fields) |
| 429 | Too Many Requests (rate limit exceeded) |
| 500 | Internal Server Error |
| 503 | Service Unavailable (models not loaded) |

## Error Response Format

```json
{
  "detail": "Error message describing what went wrong"
}
```

## File Formats

### PLY (Polygon File Format)

Generated models are in binary PLY format containing:
- Vertex positions (x, y, z)
- Vertex colors (RGB)
- Face definitions (triangles)

Compatible with:
- Blender
- MeshLab
- CloudCompare
- Three.js
- Unity/Unreal Engine

## Performance Guidelines

### Generation Times
- **GPU (NVIDIA/Apple Silicon)**: 20-40 seconds
- **CPU**: 2-10 minutes

### Grid Size Impact
- `16`: Fast, low quality (~15 seconds on GPU)
- `32`: Balanced (default, ~30 seconds on GPU)
- `64`: High quality (~60 seconds on GPU)

### File Sizes
- Typical mesh: 200KB - 2MB
- Depends on complexity and grid_size

## Rate Limiting

Currently no rate limits enforced. For production:
- Consider implementing per-user limits
- Add request queuing for heavy loads
- Monitor GPU memory usage

## Best Practices

1. **Prompt Engineering**
   - Be specific: "a red wooden chair" > "chair"
   - Include materials: "glass", "metal", "wooden"
   - Specify style: "modern", "medieval", "cartoon"

2. **User IDs**
   - Use consistent user IDs for organization
   - Consider email hashes or UUIDs
   - Helps with usage tracking

3. **Error Handling**
   - Always check `success` field
   - Handle 503 errors (models loading)
   - Implement retries with backoff

4. **File Management**
   - Download files promptly
   - Local: Clean up old files periodically
   - Production: Files expire after 30 days

## Examples

### Python
```python
import requests
import json

# Generate model
response = requests.post(
    "http://localhost:8000/generate/text",
    json={
        "prompt": "a golden trophy",
        "user_id": "python-test",
        "grid_size": 32
    }
)

result = response.json()
if result["success"]:
    print(f"Generated in {result['generation_time']}s")
    print(f"Download from: {result['file_url']}")
    
    # Download file
    download_url = f"http://localhost:8000{result['file_url']}"
    ply_data = requests.get(download_url).content
    
    with open("trophy.ply", "wb") as f:
        f.write(ply_data)
```

### JavaScript/Node.js
```javascript
const FormData = require('form-data');
const fs = require('fs');

// Text to 3D
fetch('http://localhost:8000/generate/text', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        prompt: 'a crystal vase',
        user_id: 'js-test'
    })
})
.then(res => res.json())
.then(data => {
    console.log(`Generated: ${data.file_url}`);
    console.log(`Time: ${data.generation_time}s`);
});

// Image to 3D
const form = new FormData();
form.append('file', fs.createReadStream('vase.jpg'));
form.append('user_id', 'js-test');

fetch('http://localhost:8000/generate/image', {
    method: 'POST',
    body: form
})
.then(res => res.json())
.then(data => console.log(data));
```

### cURL
```bash
# Simple generation
curl -X POST http://localhost:8000/generate/text \
  -H "Content-Type: application/json" \
  -d '{"prompt": "a samurai sword"}'

# With all options
curl -X POST http://localhost:8000/generate/text \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "a detailed wooden ship",
    "user_id": "curl-test",
    "grid_size": 64
  }' | jq

# Download the file
curl -O http://localhost:8000/download/curl-test/mesh_wooden_ship_*.ply
```
